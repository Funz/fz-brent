name: Test Brent Algorithm Plugin

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  test-loading:
    name: Test Algorithm Loading
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
        python-version: ["3.10", "3.11", "3.12"]

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}

      - name: Set up R
        uses: r-lib/actions/setup-r@v2

      - name: Install fz framework and rpy2
        run: |
          pip install git+https://github.com/Funz/fz.git
          pip install rpy2

      - name: Install test dependencies
        run: pip install pytest

      - name: Test algorithm file structure
        run: python -m pytest tests/test_plugin.py::test_algorithm_file_exists tests/test_plugin.py::test_algorithm_metadata tests/test_plugin.py::test_algorithm_r_structure -v

      - name: Test algorithm loading
        run: python -m pytest tests/test_plugin.py::test_algorithm_r_loading tests/test_plugin.py::test_with_fz_loading -v

  test-running:
    name: Test Algorithm Running
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
        python-version: ["3.10", "3.11", "3.12"]

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}

      - name: Set up R
        uses: r-lib/actions/setup-r@v2

      - name: Install fz framework and rpy2
        run: |
          pip install git+https://github.com/Funz/fz.git
          pip install rpy2

      - name: Install test dependencies
        run: pip install pytest

      - name: Test algorithm execution
        run: python -m pytest tests/test_plugin.py::test_algorithm_r_execution tests/test_plugin.py::test_algorithm_r_root_finding -v

      - name: Run full test suite
        run: python -m pytest tests/test_plugin.py -v
